# 用 tokamak-4-rocky.local 做统一入口部署脚本


## 1. 为什么加了 SSH key 还是不能 clone？

下面假设你的仓库是：

```text
Group:  AerospaceCenter
Project: HPC_project
SSH URL: git@tokamak-4-rocky.local:AerospaceCenter/HPC_project.git
```

### 1.1 区分两个 SSH 通道

* 你现在用的是：`ssh root@192.168.1.111` / `ssh root@tokamak-4-rocky.local`
  这是系统 sshd，跟 GitLab 无关。
* git clone 用的是：`ssh git@tokamak-4-rocky.local`
  GitLab 会用内部用户 `git` + `git-shell` 来处理，这一层出问题你登陆 root 也看不出来。

所以必须单独验证：

在 Windows 的终端里（PowerShell / Git Bash 都行）执行：

```bash
ssh -T git@tokamak-4-rocky.local
```

几种典型情况：

1. 如果输出类似：

   ```text
   Welcome to GitLab, @wuyuhang!
   ```

   说明：

    * 你的 SSH key 已经被 GitLab 识别
    * GitLab SSH 通道正常
      那 clone 失败多半是 **URL 写错**（比如用 root@、或者多了 ssh:// 之类的）。

2. 如果是：

   ```text
   git@tokamak-4-rocky.local: Permission denied (publickey).
   ```

   说明 Windows 这台机器 **没有正确带上私钥**，或者你上传到 GitLab 的公钥不是同一个。

   在 Windows 上检查：

   ```bash
   # 看当前有哪些 key
   ls ~/.ssh

   # 手动试一下带 key：
   ssh -i ~/.ssh/id_ed25519 git@tokamak-4-rocky.local
   ```

    * 确保你上传到 GitLab 的公钥，比如 `id_ed25519.pub`，是对应这个私钥。

3. 如果是：

   ```text
   kex_exchange_identification: Connection closed by remote host
   ```

   或类似「连接被远端关闭」，而你 ssh root 又没问题，很可能是 **SELinux 或 GitLab 自身报错**：

   在 Rocky 上看日志：

   ```bash
   sudo journalctl -u sshd -f
   sudo gitlab-ctl tail
   ```

   如果有 SELinux 的 AVC 拒绝，可以临时验证：

   ```bash
   getenforce          # 如果是 Enforcing，先试试
   sudo setenforce 0   # 临时 Permissive
   ```

   然后再在 Windows 上 `ssh -T git@tokamak-4-rocky.local` 看是否就正常了。
   如果是 SELinux 问题，你之后再按我们之前的方案加策略，或保持 Permissive。

### 1.2 确认 GitLab 的 SSH 配置和 URL

在服务器上检查 GitLab 的 ssh host / port：

```bash
sudo gitlab-rails runner 'puts Gitlab.config.gitlab.ssh_host'
sudo gitlab-rails runner 'puts Gitlab.config.gitlab.ssh_port'
```

如果不是你期望的：

* host 最好是：`tokamak-4-rocky.local`
* port 一般是：`22`（你没改的话）

那就改 `/etc/gitlab/gitlab.rb`：

```ruby
external_url 'http://tokamak-4-rocky.local'

gitlab_rails['gitlab_ssh_host'] = 'tokamak-4-rocky.local'
gitlab_rails['gitlab_ssh_port'] = 22
```

然后：

```bash
sudo gitlab-ctl reconfigure
sudo gitlab-ctl restart
```

在 GitLab 网页里打开仓库 → 右上角「Clone」
确认 “Clone with SSH” 显示的是：

```text
git@tokamak-4-rocky.local:AerospaceCenter/HPC_project.git
```

然后在 Windows 上用这个命令测试：

```bash
git clone git@tokamak-4-rocky.local:AerospaceCenter/HPC_project.git
```

### 1.3 Windows 这边的 SSH key 是否和你上传的一致？

你搬到办公室后换的是网络，但 **每台开发机的私钥是独立的**。
如果你现在用的是工位上的 Windows，而之前只给家里的 Windows 上传过公钥，那 GitLab 当然不认。

在当前 Windows 上重新生成一份 key 比较稳妥（如果还没配或者不确定）：

```bash
# PowerShell / Git Bash
ssh-keygen -t ed25519 -C "wuyuhang@aerospace.center.com"
# 一路回车，生成 ~/.ssh/id_ed25519 和 id_ed25519.pub
```

然后把 `id_ed25519.pub` 内容复制到 GitLab → User → SSH Keys 里。
再运行：

```bash
ssh -T git@tokamak-4-rocky.local
```

确认变成 `Welcome to GitLab, @wuyuhang!` 之后再尝试 clone。

---

## 2. 重新生成一套「域名解析部署脚本」

虽然你现在 `http://tokamak-4-rocky.local/admin` 已经能访问，
但我们还是给你一套「标准化部署脚本」，保证以后 IP 再变动也能稳妥复现。

### 2.1 服务器端脚本：启用 mDNS（tokamak-4-rocky.local）

保存为 `/root/setup_lanhub_server.sh`：

```bash
#!/usr/bin/env bash
set -euo pipefail

HOSTNAME="tokamak-4-rocky"

echo "[1/4] 设置主机名为 ${HOSTNAME}"
hostnamectl set-hostname "${HOSTNAME}"

echo "[2/4] 安装 Avahi 和 mDNS 组件"
dnf install -y avahi avahi-tools nss-mdns

echo "[3/4] 配置 /etc/nsswitch.conf 启用 mdns4_minimal"
cp /etc/nsswitch.conf /etc/nsswitch.conf.bak.$(date +%s)

# 如果 hosts: 行中没有 mdns4_minimal，则替换为标准配置
awk '
/^hosts:/ && $0 !~ /mdns4_minimal/ {
    print "hosts: files mdns4_minimal [NOTFOUND=return] dns myhostname";
    next
}
{ print }
' /etc/nsswitch.conf.bak.* | tee /etc/nsswitch.conf >/dev/null

echo "[4/4] 启用 Avahi 服务并开放 mDNS"
systemctl enable --now avahi-daemon.service

# 防火墙允许 mDNS（有的环境默认就开了，这里做一次显式设置）
if command -v firewall-cmd >/dev/null 2>&1; then
    firewall-cmd --add-service=mdns --permanent || true
    firewall-cmd --reload || true
fi

echo "完成。现在在局域网内应该可以 ping tokamak-4-rocky.local 了。"
```

使用方式：

```bash
chmod +x /root/setup_lanhub_server.sh
sudo /root/setup_lanhub_server.sh
```

这套配置只做一遍即可。以后你把服务器带回家、再带到办公室，只要连上 WiFi，局域网里就能通过 `tokamak-4-rocky.local` 找到它。

---

### 2.2 Windows 客户端脚本：自动更新 hosts（可选增强）

有些环境下 Windows 自己解析 `.local` 不稳定，你可以用这个脚本强制在 `hosts` 里写死当前 IP。

保存为 `lanhub_client_win.py`：

```python
#!/usr/bin/env python3
import subprocess
import re
from pathlib import Path
import sys

HOSTNAME = "tokamak-4-rocky.local"
ALIASES = ["tokamak-4-rocky", "gitlab.local"]  # 你想额外用的别名

def resolve_ip():
    print(f"解析 {HOSTNAME} ...")
    try:
        out = subprocess.check_output(
            ["ping", "-n", "1", HOSTNAME],
            encoding="utf-8",
            errors="ignore"
        )
    except subprocess.CalledProcessError as e:
        print("ping 失败，无法解析 IP")
        print(e)
        sys.exit(1)

    # 找第一个 IPv4 地址
    m = re.search(r"(\d+\.\d+\.\d+\.\d+)", out)
    if not m:
        print("未在 ping 输出中找到 IPv4 地址：")
        print(out)
        sys.exit(1)

    ip = m.group(1)
    print(f"解析到 {HOSTNAME} = {ip}")
    return ip

def update_hosts(ip: str):
    hosts_path = Path(r"C:\Windows\System32\drivers\etc\hosts")
    if not hosts_path.exists():
        print(f"找不到 hosts 文件：{hosts_path}")
        sys.exit(1)

    print(f"更新 {hosts_path} ...")

    try:
        text = hosts_path.read_text(encoding="utf-8", errors="ignore").splitlines()
    except PermissionError:
        print("无法读取 hosts 文件，请以管理员身份运行本脚本。")
        sys.exit(1)

    new_lines = []
    for line in text:
        if any(name in line for name in [HOSTNAME] + ALIASES):
            # 丢弃旧记录
            continue
        new_lines.append(line)

    names = [HOSTNAME.rstrip(".local"), HOSTNAME] + ALIASES
    new_lines.append(f"{ip} " + " ".join(names))

    try:
        hosts_path.write_text("\n".join(new_lines) + "\n", encoding="utf-8")
    except PermissionError:
        print("无法写入 hosts 文件，请以管理员身份运行本脚本。")
        sys.exit(1)

    print("hosts 更新完成。")

def main():
    ip = resolve_ip()
    update_hosts(ip)
    print("完成。现在可以用这些域名访问：")
    print("  - tokamak-4-rocky.local")
    print("  - tokamak-4-rocky")
    print("  - gitlab.local")

if __name__ == "__main__":
    main()
```

使用方式：

1. 在 Windows 安装 Python（如果还没装）。
2. 用「以管理员身份运行」打开 PowerShell / CMD。
3. 执行：

   ```bash
   python lanhub_client_win.py
   ```

之后你就可以用：

```bash
ping tokamak-4-rocky
ping gitlab.local
git clone git@tokamak-4-rocky.local:AerospaceCenter/HPC_project.git
```

来访问同一台服务器。

你也可以把这个脚本设为开机/登录执行，这样 IP 每次变化后，hosts 会自动更新。

---

### 2.3 WSL / 其他 Linux 客户端脚本（可选）

如果某些 Linux / WSL 里解析 `.local` 不稳定，可以用这个简单脚本更新 `/etc/hosts`。

保存为 `lanhub_client_unix.sh`：

```bash
#!/usr/bin/env bash
set -euo pipefail

HOSTNAME="tokamak-4-rocky.local"
ALIASES=("tokamak-4-rocky" "gitlab.local")

echo "[1/2] 解析 ${HOSTNAME} ..."
IP=$(getent hosts "${HOSTNAME}" | awk '{print $1}' || true)

if [[ -z "${IP}" ]]; then
    echo "通过 getent 无法解析，尝试使用 ping ..."
    IP=$(ping -c 1 "${HOSTNAME}" 2>/dev/null | grep -oE '([0-9]{1,3}\.){3}[0-9]{1,3}' | head -n1 || true)
fi

if [[ -z "${IP}" ]]; then
    echo "解析失败，退出。"
    exit 1
fi

echo "解析到 ${HOSTNAME} = ${IP}"

HOSTS_FILE="/etc/hosts"
TMP_FILE=$(mktemp)

echo "[2/2] 更新 ${HOSTS_FILE} ..."
sudo cp "${HOSTS_FILE}" "${HOSTS_FILE}.bak.$(date +%s)"

# 过滤掉已有的相关记录
grep -vE "tokamak-4-rocky|gitlab.local" "${HOSTS_FILE}" > "${TMP_FILE}" || true

{
    echo "${IP} tokamak-4-rocky ${HOSTNAME} gitlab.local"
} | sudo tee -a "${TMP_FILE}" >/dev/null

sudo mv "${TMP_FILE}" "${HOSTS_FILE}"

echo "完成。现在可以用 tokamak-4-rocky / tokamak-4-rocky.local / gitlab.local 访问。"
```

使用方式（在 WSL / Linux 客户端上）：

```bash
chmod +x lanhub_client_unix.sh
./lanhub_client_unix.sh
```

---

## 3. 建议你按这个顺序操作

1. 在 Rocky 上跑一次 `/root/setup_lanhub_server.sh`，确保 mDNS & 主机名统一。
2. 在当前 Windows 客户端上：

    * 先 `ssh -T git@tokamak-4-rocky.local` 看看 GitLab SSH 通道是否通。
    * 如果是 `Permission denied (publickey)`，按 1.3 重新生成并配置 SSH key。
    * 再用 GitLab 页面里「Clone with SSH」显示的 URL 去 `git clone`。
3. 如果你想把域名彻底固定（不依赖 .local 解析），再用 `lanhub_client_win.py` / `lanhub_client_unix.sh` 更新 hosts，之后所有 clone 都建议统一用：


   ```bash
   git@tokamak-4-rocky.local:AerospaceCenter/HPC_project.git
   ```


   ```bash
   git clone git@tokamak-4-rocky.local:AerospaceCenter/HPC_project.git
   ```

你先按上面的步骤试一轮。如果中间某一步出现具体错误信息（尤其是 `ssh -T git@tokamak-4-rocky.local` 的输出），贴出来，我可以帮你进一步“定点爆破”。

